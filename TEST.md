# 부하 테스트 계획 문서

## 1. 요약

본 문서는 `duck-commerce` 프로젝트의 **쿠폰 발급 API**에 대한 부하 테스트 계획을 수립하고, 테스트 대상 선정 기준, 목적, 시나리오 및 테스트 환경을 상세히 정의하는 것을 목표로 한다. 부하 테스트를 통해 높은 트래픽 환경에서도 안정적으로 시스템이 작동하는지 검증하고, 주요 성능 병목을 분석하여 개선할 수 있도록 한다.

## 2. 서론

### 2.1 연구 목적

- 대량 트래픽이 발생하는 상황에서 시스템의 **처리량(Throughput), 응답 속도(Response Time), 오류율(Error Rate)** 등을 측정하여 **성능 한계를 파악**한다.
- 부하 증가에 따른 **시스템의 안정성 및 확장성(Scalability)** 을 평가한다.
- 특정 상황에서 발생할 수 있는 **장애(Timeout, Deadlock, Connection Pool Exhaustion 등)** 를 사전에 발견하고 대응책을 마련한다.
- 성능 테스트 결과를 기반으로 **DB 쿼리 최적화, 캐싱 도입, 서버 인프라 조정 등 최적화 작업**을 수행할 계획이다.

### 2.2 테스트 대상 선정 기준

본 테스트의 대상은 `duck-commerce` 프로젝트 내에서 트래픽 부하가 가장 많이 발생할 것으로 예상되는 **쿠폰 발급 API (`POST /api/v1/coupons/assign`)** 이다.

해당 API를 대상으로 하는 이유는 다음과 같다:

✅ **트래픽 집중 가능성**
• 프로모션 이벤트나 특정 마케팅 활동 시 대량의 사용자가 동시에 쿠폰을 발급받으려고 할 가능성이 높다.
• 동시 요청이 증가할 경우, API 성능 저하 또는 타임아웃이 발생할 가능성이 크다.

✅ **DB 부하 발생 가능성**
• 쿠폰 발급 시 **사용자 계정, 쿠폰 발급 기록, 재고 데이터** 등의 테이블을 업데이트해야 하므로, **트랜잭션 경합과 DB 락**이 발생할 가능성이 있다.
• 반복적인 조회 및 업데이트가 많아, **DB 커넥션 풀과 인덱스 최적화**가 필요하다.

✅ **비즈니스 영향도가 높은 API**
• **쿠폰 발급 실패**는 사용자 경험에 직접적인 영향을 미친다.
• 원활한 API 응답 성능 확보가 필요하다.

## 3. 연구 방법

### 3.1 부하 테스트 주요 지표

테스트 수행 후 측정할 주요 성능 지표는 다음과 같다:

| **성능 지표** | **목표 수치** | **설정 근거** |
| --- | --- | --- |
| **Throughput (TPS, RPS)** | 초당 1000건 이상 | 기존 운영 중인 피크 트래픽 대비 1.5배 여유 적용 |
| **Latency (응답 지연 시간)** | 평균 500ms 이하 | 실시간 서비스 UX 고려 (1초 이내가 일반적이나 더 빠른 응답 요구됨) |
| **95% 응답 시간** | 1초 이하 | 트래픽 피크 시에도 원활한 서비스 제공을 위해 설정 |
| **Error Rate (오류율)** | 0.01% 이하 | 실제 프로덕션 환경에서 허용 가능한 최대 수치 |
| **CPU/Memory Usage** | CPU 80% 이하, RAM 85% 이하 | 안정적인 시스템 운영을 위한 목표 |
| **DB Connection Usage** | Connection Pool 내 90% 이하 사용 | 동시 DB 요청 처리 용량 확보 |

### 3.2 부하 테스트 환경

✅ **서버 환경**

- **애플리케이션:** Spring Boot (duck-commerce)
- **DB:** MySQL (Docker 컨테이너 사용)
- **캐시:** Redis
- **로드 테스트 도구:** k6
- **CPU/RAM 제한:** 컨테이너당 2 vCPU, 4GB RAM (테스트 환경 기준)
- **네트워크 설정:** 1Gbps 제한 (테스트 환경 기준)

✅ **테스트 데이터**

- **사용자 계정:** 10,000개
- **쿠폰 데이터:** 500개 (중복 사용 가능)
- **요청 유형:** JSON 기반 API 요청 (POST /api/v1/coupons/assign)

## 4. 테스트 시나리오

**4.1 기본 부하 테스트 시나리오**

💡 **k6를 이용한 부하 테스트 설정**

```
export const options = {
    stages: [
        { duration: '1m', target: 100 },
        { duration: '2m', target: 500 },
        { duration: '3m', target: 1000 },
        { duration: '2m', target: 1000 },
        { duration: '1m', target: 500 },
        { duration: '30s', target: 0 },
    ],
};

```

🔹 **테스트 실행 방식**
• 동시 요청을 점진적으로 증가시켜 서버의 최대 처리 용량을 파악
• 특정 시간 동안 최대 부하를 유지하여 성능 저하 여부를 분석
• 부하를 점진적으로 감소시키며 **시스템이 정상적으로 회복되는지** 확인

**4.2 추가 테스트 시나리오**

부하 테스트 외에도 시스템의 안정성을 검증하기 위해 추가 테스트를 진행한다.

**✅ 1) 스트레스 테스트 (최대 몇 명까지 견딜 수 있는가?)**

- **목적:** 서버의 최대 처리량을 초과하는 트래픽을 유발하여 **성능 한계점**을 확인
- **시나리오:**
- 동시 사용자 수를 **5000명 → 10000명**까지 증가시키면서 서버의 응답 속도 및 오류율을 측정
- 서버가 어느 시점에서 성능 저하가 발생하는지 확인
- DB 커넥션 풀과 트랜잭션 충돌 문제를 탐색

**✅ 2) 장애 복구 테스트 (서버 장애 발생 시 정상 복구 여부)**

- **목적:** 서버 또는 DB 장애 발생 시 **정상적인 장애 대응 및 복구 가능 여부**를 검증
- **시나리오:**
- **DB를 강제 종료**한 후, 요청을 보냈을 때 **API가 정상적으로 예외 처리를 수행하는지** 확인
- **서버 프로세스를 강제 종료**하고 재시작 시 기존 트랜잭션이 정상적으로 복구되는지 검증
- **자동 복구(Auto Scaling) 설정이 적용될 경우**, 새로운 서버가 정상적으로 트래픽을 수용하는지 확인

**✅ 3) 내구성 테스트 (장시간 부하 유지 시 성능 저하 여부)**

- **목적:** 서버가 장시간 부하를 받을 경우 **메모리 누수, 성능 저하, 장애 발생 여부**를 확인
- **시나리오:**
- 초당 1000건 이상의 요청을 **8시간 동안 지속적으로 발생**시키고, 메모리 사용량과 응답 시간을 분석
- 특정 시간이 지나면 성능이 저하되는지 확인
- 서버 리소스(CPU, RAM) 사용률이 일정하게 유지되는지 모니터링

## 5. 결론 및 기대 효과

✅ 본 부하 테스트를 통해 **다음과 같은 개선을 기대할 수 있음**:

1. **API 성능 최적화**: 평균 응답 시간 500ms 이내 유지, 초당 1000건 이상 처리 가능
2. **DB 부하 감소**: 인덱스 최적화 및 Redis 캐싱 적용 후 성능 개선 확인
3. **확장성 검증**: Auto Scaling 적용 시 효과적인 부하 분산 가능성 분석
4. **장애 대응력 강화**: 장애 발생 시 자동 복구 및 서비스 지속 가능성 검증

✅ 향후 개선 계획:

- **Auto Scaling 설정 조정**: 트래픽 증가 시 빠르게 대응할 수 있도록 조정 필요
- **비동기 큐(Kafka) 도입 검토**: 대량 트랜잭션 처리 성능 향상 기대
- **DB 최적화 지속 진행**: 쿼리 실행 속도 개선 및 불필요한 인덱스 제거